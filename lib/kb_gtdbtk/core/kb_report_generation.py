'''
Create a KBase Report for a GTDB-tk run.
'''

import uuid

from shutil import copyfile
from typing import Dict, List, Callable
from pathlib import Path

from kb_gtdbtk.core.kb_client_set import KBClients


def generate_report(
        clients: KBClients,
        gtdbtk_output_dir: Path,
        workspace_id: int,
        objects_created: List[Dict[str,str]],
        file_links: List[Dict[str,str]],
        uuid_gen: Callable[[], uuid.UUID] = uuid.uuid4):
    '''
    Create a KBase report for a GTDB-tk run.

    :param clients: The KBase client set.
    :param gtdbtk_output_dir: The directory containing the GTDB-tk results as JSON files,
        generated by kb_gtdbtk.core.gtdbtk_runner.run_gtdbtk.
    :param workspace_id: The ID of the workspace in which to save the report.
    :param objects_created: A list of objects_created: ref and descriptiom.
    :param file_links: A list of files_links: shock_id, name, and descriptiom.
    '''

    # don't document uuid_gen, meant for testing only
    # TODO input checking
    report_name = 'GTDBTk_report_' + str(uuid_gen())
    copyfile(Path(__file__).parent / 'index.html', gtdbtk_output_dir / 'index.html')

    upload_ret = clients.dfu().file_to_shock({'file_path': str(gtdbtk_output_dir),
                                              'make_handle': 0,
                                              'pack': 'zip'})
    
    output_file_archive = {
        'shock_id': upload_ret['shock_id'],
        'name': 'GTDB-Tk_classify_wf.zip',
        'description': 'GTDB-Tk Classify WF output'
        }
    file_links.append (output_file_archive)
    
    html_file = {
        'path': str(gtdbtk_output_dir),
        'name': 'index.html',
        'label': 'index.html',
        'description': 'GTDB-Tk Classify Report'
        }

    report_params = {
                    'direct_html_link_index': 0,
                    'html_links': [html_file],
                    'file_links': file_links,
                    'report_object_name': report_name,
                    'workspace_id': workspace_id
    }
    if objects_created:
        report_params['objects_created'] = objects_created

    report_info = clients.report().create_extended_report(report_params)

    return {
        'report_name': report_info['name'],
        'report_ref': report_info['ref'],
        'archive_shock_id': upload_ret['shock_id']
    }

#
# define display information
#
name: Classify Microbes with GTDB-Tk - v2.1.0

tooltip: |
    Obtain objective taxonomic assignments for bacterial and archaeal genomes based on the Genome Taxonomy Database (GTDB) ver R07-RS207

screenshots: [GTDB_Report.png]

icon: icon.jpg

#
# define a set of similar apps that might be useful to the user
#
suggestions:
    apps:
        related:
            [app1, app2]
        next:
            [app3, app4]

#
# Configure the display and description of parameters
#
parameters :
    input_object_ref :
        ui-name : |
            Input
        short-hint : |
            A binned contigs object, assembly set, or genome set
        long-hint  : |
            An assembly set or genome set.  Also accepts Binned Contigs object.  Use Build AssemblySet or Build GenomeSet if have just one object.
    output_tree_basename :
        ui-name : |
            Tree Base Name
        short-hint : |
            The basename for the Tree objects.  There are often multiple trees, so each tree object name will extend the output Tree Base Name.
    min_perc_aa :
        ui-name : |
            Minimum Alignment Percent
        short-hint : |
            Filter out genomes with an insufficient percentage of AAs in the MSA (default: 10)
    copy_proximals :
        ui-name : |
            Copy GTDB hits (for genomes)
        short-hint : |
            Copy proximal GTDB hits to this narrative and create GenomeSets for each query and overall.
    save_trees :
        ui-name : |
            Save Trees (for genomes)
        short-hint : |
            Save all trimmed GTDB trees as KBase objects.  Does not save full tree with all leaves, just what is displayed in report.  Copies over genome objects in trees.
    keep_intermediates :
        ui-name : |
            Keep Intermediate Files
        short-hint : |
            Retain intermediate files generated by classify_wf
    overwrite_tax :
        ui-name : |
            Overwrite Taxonomy (for genomes)
        short-hint : |
            If input is a GenomeSet that already has taxonomy defined, then overwrite Genome objects with GTDB classification
    dendrogram_report :
        ui-name : |
            Dendrogram Trees in Report
        short-hint : |
            Show Trees as dendrogram instead of evolutionary distance-based branch lengths


description : |
    <h3>Description</h3>
    <p><b><a href="https://github.com/Ecogenomics/GTDBTk">GTDB-Tk v2.1.0</a></b> is a software toolkit for assigning objective taxonomic classifications to bacterial and archaeal genomes. It is designed to work with recent advances that allow hundreds or thousands of metagenome-assembled genomes (MAGs) to be obtained directly from environmental samples. It can also be applied to isolate and single-cell genomes. If the input is a GenomeSet, the App will optionally overwrite the Taxonomy information in the Genome object(s).</p>

    <i>Notes:</i><br>
    <p>As of v2.0.0, the GTDB-Tk Classify workflow by default uses order-level subtrees rather than the entire Bacterial tree.  This uses far less memory.  An option to use the full tree is provided.</p>
    <p>As of v2.0.0, intermediate files in the classification workflow are deleted.  An option to keep those intermediate files is provided.</p>
    <p>Individual Genome objects must first be placed into a GenomeSet to be used as input.  This is to avoid accidentally running the App multiple times, once for each Genome, which is very inefficient.  Similarly, individual Assembly objects must be placed into an AssemblySet object.  The utility Apps Build GenomeSet or Build AssemblySet can be used for this purpose.</p>


    <p><hr></p>
    <p><h3>Tool and Data Sources:</h3></p>
    <p>GTDB-Tk v2.1.0 is installed from <a href="https://github.com/Ecogenomics/GTDBTk">https://github.com/Ecogenomics/GTDBTk</a></p>

    <p>This app is using gtdbtk release 207 data <a href="https://data.gtdb.ecogenomic.org/releases/release207/207.0/auxillary_files/gtdbtk_r207_v2_data.tar.gz">https://data.gtdb.ecogenomic.org/releases/release207/207.0/auxillary_files/gtdbtk_r207_v2_data.tar.gz</a> (warning: clicking on link will start download 62.74 GB of data). This reference data corresponds to the GTDB R07-RS207 release.</p>

    <p><a href='https://gtdb.ecogenomic.org/'>The Genome Taxonomy Database (GTDB)</a> is constructed from RefSeq and Genbank genomes, and releases are indexed to RefSeq releases. All genomes are quality controlled using <a href='https://github.com/Ecogenomics/CheckM/wiki'>CheckM</a> and those statistics can be found on the <a href='https://gtdb.ecogenomic.org/stats'>GTDB website</a>.</p>
    

    <p><hr></p>
    <h3>Usage</h3>

    <p>GTDB-Tk Classify will place your Binned Contigs, Assemblies, or Genomes (from a GenomeSet or a Species Tree) into the GTDB Taxonomy.  Additionally, the KBase implementation will allow the user to copy the GTDB species representative Genome objects to their Narrative, as well as any members in the Species Tree from the GTDB-Tk classify placement.  Options for those copy operations, as well as whether to overwrite any existing taxonomic classification in the query genome objects, are available, as described in the <b><i>Parameters</i></b> section below.</p>

    <p>In addition to the visual reports (see below) and the GTDB species representative <b><i>Genome</i></b> objects, this App has the option of generative KBase <b><i>Species Tree</i></b> objects, which can be used in subsequent analyses such as Pangenome Calculations with the <a href="https://narrative.kbase.us/#catalog/apps/kb_motupan/run_kb_motupan">mOTUpan</a> App.</p>

    <h4>GTDB Species Tree Tab</h4>
    
    <p><b><i>dendrogram / ultrametric tree</i></b><br>
    <img height=300 src="https://raw.githubusercontent.com/kbaseapps/kb_gtdbtk/dylan_20230607/ui/narrative/methods/run_kb_gtdbtk_classify_wf/img/gtdbtk.ar53.classify-trimmed.tree-circle-ultrametric.png"></p>
    <p>Queries are placed into the GTDB Species Tree.  While a uniform dendrogram and a evolutionary distance-based branch length version of the tree are generated by the App, the User has the option of the report including the dendrogram or the phylogenetic branch length version of the image.  Both versions are available for Download in both bitmap (PNG) and vector (PDF) formats.  A key which indicates taxonomic membership of each leaf is provided corresponding to the outer circle on the plot.  One tree for any Archaea and typically one tree per Bacterial phylum are included in the output.  The Queries are in yellow and proximal lineages found by GTDB-Tk Classify in lavender.  The remaining tree is trimmed to include one species representative per branch attached to the primary branches within which the queries and proximal species are found.  These genomes are selected following the same weighting as used by GTDB to select species representatives, with an added term with the greatest weight to select the GTDB genus representatives.</p>

    <p><b><i>phylogenetic tree</i></b><br>
    <img height=300 src="https://raw.githubusercontent.com/kbaseapps/kb_gtdbtk/dylan_20230607/ui/narrative/methods/run_kb_gtdbtk_classify_wf/img/gtdbtk.ar53.classify-trimmed.tree-circle.png"></p>
    <p>As an alternative to the uniform dendrogram version of the tree, a proper phylogenetic tree with branch lengths indicating evolutionary distance is available and can be configured to be what is shown in the report.  Regardless, it can be downloaded as the tree without the label "ultrametric".</p>

    <p><b><i>rectangular tree</i></b><br>
    <img height=300 src="https://raw.githubusercontent.com/kbaseapps/kb_gtdbtk/dylan_20230607/ui/narrative/methods/run_kb_gtdbtk_classify_wf/img/gtdbtk.ar53.classify-trimmed.tree-rectangle.png"></p>
    <p>Rectangular tree images are also generated and available for download.</p>

    <p><b><i>bacterial trees</i></b><br>
    <img height=300 src="https://raw.githubusercontent.com/kbaseapps/kb_gtdbtk/dylan_20230607/ui/narrative/methods/run_kb_gtdbtk_classify_wf/img/gtdbtk.bac120.classify.tree.3-trimmed.tree-circle-ultrametric.png"></p>
    <p>While the Archaea are all placed within a single tree, Bacterial queries are placed within separate trees, typically one phylum per tree.</p>

    <h4>Genome objects</h4>
    <p>The user has the option of copying the GTDB species representative <b><i>Genome</i></b> objects into the current workspace.  This can be done for the proximal species representatives as well as the more distal lineages found in the trimmed Species Tree (see above).  If this is done, any <b><i>Genome Sets</i></b> and <b><i>Species Tree</i></b> objects will refer to the local <b><i>Genome</i></b> copies.  Therefore, subsequent analyses, such as <b><i>Pangenome</i></b> calculations, will use these local copies.</p>

    <h4>Genome Sets</h4>
    <p>Genome Sets are produced for the proximal species representatives identified by GTDB-Tk Classify.  The User may wish to adjust the membership of which genomes are in the Genome Set and can do so with Apps such as <b>Remove Genome from GenomeSet</b> or <b>Trim Species Tree to GenomeSet</b> prior to further analysis.</p>

    <h4>Species Trees</h4>
    <p>Species Tree objects can also be produced by GTDB-Tk Classify.  One will be generated that contains just the query genomes and the proximal species hits, as well as a Species Tree that includes the greater set of distal genomes from the trimmed tree.  There will be one for Archaea and one for each Bacterial phylum.</p>


    <h4>Krona Plot Tab</h4>
    <p><img height=300 src="https://raw.githubusercontent.com/kbaseapps/kb_gtdbtk/dylan_20230607/ui/narrative/methods/run_kb_gtdbtk_classify_wf/img/GTDB_Krona.png"></p>
    <p>The classifications will also be available using the <a href="">Krona</a> visualization.</p>


    <h4>Bacteria and Archaea Classification Tabs</h4>
    <p><img height=300 src="https://raw.githubusercontent.com/kbaseapps/kb_gtdbtk/dylan_20230607/ui/narrative/methods/run_kb_gtdbtk_classify_wf/img/GTDB_Classification-1.png"></p>
    <p>A table with the classifications is also available in the App report.  Bacterial and Archaeal classifications are in separate tabs.  Columns for the consensus classification (often only to a higher taxonomic level than species) and ANI assignment are given.</p>
    
    <p><img height=300 src="https://raw.githubusercontent.com/kbaseapps/kb_gtdbtk/dylan_20230607/ui/narrative/methods/run_kb_gtdbtk_classify_wf/img/GTDB_Classification-2.png"></p>
    <p>The classification tabs also include tree-placement-based classification, terms used in the determination of the placement, and other notes and the GTDB ID of additional proximal species representative genomes.  Please see the GTDB-Tk paper for the full details.</p>


    <h4>Bacteria and Archaea Marker Gene Tabs</h4>
    <p><img height=300 src="https://raw.githubusercontent.com/kbaseapps/kb_gtdbtk/dylan_20230607/ui/narrative/methods/run_kb_gtdbtk_classify_wf/img/GTDB_Marker_gene_summary.png"></p>
    <p>Lastly there are two tabs, one for Bacteria and one for Archaea, with the phylogenetic marker genes used in the taxonomic placement by GTDB-Tk.  Often, not all markers are found in a given query, and the presence or absence of a marker is indicated in this table.</p>


    <h4>Downloadable Files</h4>
    <p><img height=300 src="https://raw.githubusercontent.com/kbaseapps/kb_gtdbtk/dylan_20230607/ui/narrative/methods/run_kb_gtdbtk_classify_wf/img/GTDB_Download_files.png"></p>
    <p>The entire working directory used in the GTDB-Tk Classify calculations and all output are availble for download as a zip archive with the file name "GTDB-Tk_classify_wf.zip".  Additionally, several key output files generated by the KBase App version of GTDB-Tk Classify can be downloaded, including the PNG and PDF versions of the trees described above, the newick versions of the proximal and trimmed trees, as well as a file with the GTDB lineage for each query and each member of the species trees.  This set of downloadable files is available for the Archaea with the prefix "gtdbtk.ar53.classify" and for Bacteria, one per phylum, with the prefix "gtdbtk.bac120.classify.tree.#" where "#" is just an index for the phyla.</p>
    

    <p><hr></p>
    <p><strong>Team members who implemented App in KBase:</strong> <a href="https://narrative.kbase.us/#people/dylan">Dylan Chivian</a> and <a href="https://narrative.kbase.us/#people/psdehal">Paramvir Dehal</a>. For questions, please <a href=”http://www.kbase.us/support/”>contact us</a>.</p>

    <p>If you use GTDB-Tk in KBase, please cite</p>
    <ul><li>Chivian D, Jungbluth SP, Dehal PS, Wood-Charlson EM, Canon RS, Allen BH, Clark MM, Gu T, Land ML, Price GA, Riehl WJ, Sneddon MW, Sutormin R, Zhang Q, Cottingham RW, Henry CS, Arkin AP. Metagenome-assembled genome extraction and analysis from microbiomes using KBase. Nat Protoc. 2023 Jan;18(1):208-238. doi: 10.1038/s41596-022-00747-x
    </ul>

    <b>Primary References</b>
    <p>GTDB-Tk is described in:</p>
        <ul>
            <li>Chaumeil PA, Mussig AJ, Hugenholtz P, Parks DH. 2022 <a href="https://academic.oup.com/bioinformatics/article/38/23/5315/6758240" rel="nofollow">>GTDB-Tk v2: memory friendly classification with the genome taxonomy database</a>. <i>Bioinformatics</i>, btac672</li>
        </ul>
    <p>The Genome Taxonomy Database (GTDB) is described in:</p>
        <ul>
            <li>Parks DH, Chuvochina M, Rinke C, Mussig AJ, Chaumeil PA, Hugenholtz P. 2022 <a href="https://academic.oup.com/nar/article/50/D1/D785/6370255" rel="nofollow">GTDB: an ongoing census of bacterial and archaeal diversity through a phylogenetically consistent, rank normalized and complete genome-based taxonomy</a>. <i>Nucleic Acids Research</i>, gkab776</li>
        </ul>
    

    <p>We also strongly encourage you to cite the following 3rd party dependencies:</p>
    <ul>
        <li>
        Matsen FA, Kodner RB, Armbrust EV. 2010. <a href="https://www.ncbi.nlm.nih.gov/pubmed/21034504">pplacer: linear time maximum-likelihood and Bayesian phylogenetic placement of sequences onto a fixed reference tree</a>. <i>BMC Bioinformatics</i>, 11:538.
        </li>
        <li>
        Jain C, et al. 2017. <a href="https://www.biorxiv.org/content/early/2017/11/27/225342">High-throughput ANI Analysis of 90K Prokaryotic Genomes Reveals Clear Species Boundaries</a>. <i>bioRxiv</i>, <a href="https://doi.org/10.1101/225342">https://doi.org/10.1101/225342</a>.
        </li>
        <li>
        Hyatt D, et al. 2010. <a href="https://www.ncbi.nlm.nih.gov/pubmed/20211023">Prodigal: prokaryotic gene recognition and translation initiation site identification</a>. <i>BMC Bioinformatics</i>, 11:119. doi: 10.1186/1471-2105-11-119.
        <li>
        Price MN, Dehal PS, Arkin AP. 2010. <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2835736/">FastTree 2 - Approximately Maximum-Likelihood Trees for Large Alignments</a>. <i>PLoS One</i>, 5, e9490.
        </li>
        <li>
        Eddy SR. 2011. <a href="https://www.ncbi.nlm.nih.gov/pubmed/22039361">Accelerated profile HMM searches</a>. <i>PLOS Comp. Biol.</i>, 7:e1002195.
        </li>
    </ul>
    
publications : 
    -
        pmid: 36218463
        display-text: |
            Pierre-Alain Chaumeil, Aaron J Mussig, Philip Hugenholtz, Donovan H Parks. GTDB-Tk v2: memory friendly classification with the genome taxonomy database. Bioinformatics, Volume 38, Issue 23, 1 December 2022, Pages 5315–5316. DOI: https://doi.org/10.1093/bioinformatics/btac672
        link: https://academic.oup.com/bioinformatics/article/38/23/5315/6758240
    -
        pmid: 31730192
        display-text: |
            Pierre-Alain Chaumeil, Aaron J Mussig, Philip Hugenholtz, Donovan H Parks, GTDB-Tk: a toolkit to classify genomes with the Genome Taxonomy Database, Bioinformatics, Volume 36, Issue 6, 15 March 2020, Pages 1925–1927. DOI: https://doi.org/10.1093/bioinformatics/btz848
        link: https://doi.org/10.1093/bioinformatics/btz848
    -
        pmid: 34520557
        display-text: |
            Donovan H Parks, Maria Chuvochina, Christian Rinke, Aaron J Mussig, Pierre-Alain Chaumeil, Philip Hugenholtz. GTDB: an ongoing census of bacterial and archaeal diversity through a phylogenetically consistent, rank normalized and complete genome-based taxonomy. Nucleic Acids Research, Volume 50, Issue D1, 7 January 2022, Pages D785–D794. DOI: https://doi.org/10.1093/nar/gkab776
        link: https://academic.oup.com/nar/article/50/D1/D785/6370255
    -
        pmid: 30148503
        display-text: |
            Parks, D., Chuvochina, M., Waite, D. et al. A standardized bacterial taxonomy based on genome phylogeny substantially revises the tree of life. Nat Biotechnol 36, 996–1004 (2018). DOI: https://doi.org/10.1038/nbt.4229
        link: http://dx.doi.org/10.1038/nbt.4229
    -
        pmid: 32341564
        display-text: |
            Parks DH, Chuvochina M, Chaumeil PA, Rinke C, Mussig AJ, Hugenholtz P. A complete domain-to-species taxonomy for Bacteria and Archaea. Nat Biotechnol. 2020;10.1038/s41587-020-0501-8. DOI:10.1038/s41587-020-0501-8        
        link: https://www.nature.com/articles/s41587-020-0501-8
    -
        pmid: 34155373
        display-text: |
            Rinke C, Chuvochina M, Mussig AJ, Chaumeil PA, Davín AA, Waite DW, Whitman WB, Parks DH, and Hugenholtz P. A standardized archaeal taxonomy for the Genome Taxonomy Database. Nat Microbiol. 2021 Jul;6(7):946-959. DOI:10.1038/s41564-021-00918-8
        link: https://www.nature.com/articles/s41564-021-00918-8
    -
        pmid: 21034504
        display-text: |
            Matsen FA, Kodner RB, Armbrust EV. pplacer: linear time maximum-likelihood and Bayesian phylogenetic placement of sequences onto a fixed reference tree. BMC Bioinformatics. 2010;11:538. Published 2010 Oct 30. doi:10.1186/1471-2105-11-538
        link: https://pubmed.ncbi.nlm.nih.gov/21034504/
    -
        pmid: 36376589
        display-text: |
            Chivian D, Jungbluth SP, Dehal PS, Wood-Charlson EM, Canon RS, Allen BH, Clark MM, Gu T, Land ML, Price GA, Riehl WJ, Sneddon MW, Sutormin R, Zhang Q, Cottingham RW, Henry CS, Arkin AP. Metagenome-assembled genome extraction and analysis from microbiomes using KBase. Nat Protoc. 2023 Jan;18(1):208-238. doi: 10.1038/s41596-022-00747-x
        link: https://www.nature.com/articles/s41596-022-00747-x
    -
        pmid: 30504855
        display-text: |
            Jain C, Rodriguez-R LM, Phillippy AM, Konstantinidis KT, Aluru S. High throughput ANI analysis of 90K prokaryotic genomes reveals clear species boundaries. Nat Commun. 2018;9(1):5114. Published 2018 Nov 30. DOI:10.1038/s41467-018-07641-9
        link: https://www.nature.com/articles/s41467-018-07641-9
    -
        pmid: 20211023
        display-text: |
            Hyatt D, Chen GL, Locascio PF, Land ML, Larimer FW, Hauser LJ. Prodigal: prokaryotic gene recognition and translation initiation site identification. BMC Bioinformatics. 2010;11:119. Published 2010 Mar 8. DOI:10.1186/1471-2105-11-119
        link: https://pubmed.ncbi.nlm.nih.gov/20211023/
    -   
        pmid: 20224823
        display-text: |
            Price MN, Dehal PS, Arkin AP. FastTree 2--approximately maximum-likelihood trees for large alignments. PLoS One. 2010;5(3):e9490. Published 2010 Mar 10. DOI:10.1371/journal.pone.0009490
            link: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2835736/
    -   
        pmid: 22039361
        display-text: |
            Eddy SR. Accelerated Profile HMM Searches. PLoS Comput Biol. 2011;7(10):e1002195. DOI:10.1371/journal.pcbi.1002195
        link: https://pubmed.ncbi.nlm.nih.gov/22039361/      
    
